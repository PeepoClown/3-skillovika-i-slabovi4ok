## 9. Виртуальная память. Страничная организация памяти: таблицы страниц. Стратегии управления виртуальной памятью. Схемы преобразования адресов. Алгоритмы "выталкивания" страниц: выталкивание случайной страницы, FIFO, LRU, LFU, NUR, метод связанных пар - размер страницы. Рабочее множество: определение, стратегия рабочего множества. Анализ страничного распределения.

Виртуальная память — это совокупность программно-аппаратных средств, позволяющих пользователям писать программы, размер которых превосходит
имеющуюся оперативную память. Для этого виртуальная память решает следующие задачи автоматически:
- размещает данные в запоминающих устройствах разного типа, например, часть программы в оперативной памяти, а часть на диске;
- перемещает по мере необходимости данные между запоминающими устройствами разного типа, например, подгружает нужную часть программы с диска в оперативную память;
- преобразует виртуальные адреса в физические.

Наиболее распространёнными реализациями виртуальной памяти является страничное, сегментное и странично-сегментное распределение памяти, а также свопинг.

Принцип организации:
- Все обращения к памяти в рамках процесса представляют собой виртуальные адреса, которые динамически транслируются в физические адреса во время исполнения.
Это означает, что процесс может быть выгружен на диск и вновь загружен в основную память, так что во время работы он может находиться в разных местах основной памяти.
- Процесс может быть разбит на ряд частей (страниц), которые необязательно должны располагаться в основной памяти единым непрерывным блоком. Это обеспечивается
за счёт динамической трансляции адресов и использования таблицы страниц.

### Страничная организация памяти
Виртуальное адресное пространство каждого процесса делится на части одинакового, фиксированного для данной системы размера(обычно 4кб), называемые виртуальными страницами.
В общем случае размер виртуального адресного пространства не является кратным размеру страницы, поэтому последняя страница каждого процесса дополняется фиктивной областью.
Вся оперативная память машины также делится на части такого же размера, называемые физическими страницами (или блоками).

При загрузке операционная система создаёт для каждого процесса информационную структуру — таблицу страниц, в которой устанавливается соответствие между номерами
виртуальных и физических страниц для страниц, загруженных в оперативную память, или делается отметка о том, что виртуальная страница выгружена на диск.
Кроме того, в таблице страниц содержится управляющая информация, такая как признак модификации страницы, признак невыгружаемости (выгрузка некоторых страниц
может быть запрещена), признак обращения к странице (используется для подсчёта числа обращений за определённый период времени) и другие данные используемые механизмом виртуальной памяти.

При выполнении программы, которая находится не целиком в памяти, процесс потребует страницу, которой нет в оперативной памяти - возникнет исключение,
которое будет обработано в режиме ядра. В результате менеджер памяти попытается загрузить страницу в свободную память, а процесс на это время будет заблокирован.
По завершении работы менеджера памяти страница будет загружена и процесс будет продолжать выполнятся с той команды, на которой возникло исключение.
Если свободная страница в физической памяти отсутствует, то менеджер памяти должен выбрать страницу для замещения.

Стратегии управления страничным обменом между ЖД и оперативной памятью:

ПРИСУТСТВИЕ
- Стратегия выборки («когда?») – предварительная выборка, которая подготавливает данные до того, как процесс запросил оперативную память.
- Стратегия размещения («где?») – находит первый подходящий раздел, либо первые страницы, которые схожи по запрашиваемой памяти.

МОДИФИКАЦИЯ
- Стратегия замещения («какие?») - определяет выбор страниц в основной памяти для замещения их загружаемыми из вторичной памяти;
- Управление резидентным множеством – работает по принципу фиксированного размера, переменного размера, локальной и глобальной зоной видимости. 
В случае с резидентным множеством, мы используем те страницы, которые требует процесс самостоятельно.

ОБРАЩЕНИЕ 
- Стратегия очистки - выполняется по требованию или предварительно.
- Управление загрузкой – находит 50% и затем остальные 50% очищает.

Существует три схемы преобразования виртуального адреса в физический.

1. Прямой.(БАЗА)
Таблица страниц находится в оперативной памяти. Таких страниц столько - сколько процессов. В процессоре должен находится регистр начального адреса таблицы страниц.
Виртуальный адрес состоит из двух частей.
   - Смещение d.
   - Номер страницы p.
Номер страницы используется как смещение дескриптора страницы в таблице страниц. Если страница загружена в память, то выполняя преобразование мы можем получить
линейный физический адрес. Если страница не загружена в память, то возникнет страничное исключение

![таблица виртуальных страниц](./img/os_9_1.png)

2. Ассоциативное отображение. В чистом виде не используется. Использование ассоциативной памяти – память, которая обеспечивает выборку по ключу за 1 такт.
3. Ассоциативное – прямое отображение. Комбинация первых двух методов.

Алгоритмы "выталкивания" страниц:

1. Выталкивание случайной страницы (первая попавшееся). Для замены выбирается любая случайная страница.
Недостатки:
- Может быть вытолкнута часто используемая или только что загруженная страница.
Преимущества:
- Малые накладные расходы

2. FIFO. Выталкивается та, которая дольше всего находится в памяти. Для реализации этого способа нужно организовать очередь либо хранить время.
Недостатки:
- Может быть выгружена часто используемая страница.
- (особенность) Существуют такие траектории загрузки страниц, когда увеличение страничной памяти ведет к увеличению страничных прерываний.
Преимущества:
- страничное прерывание. Если нужно загрузить страницу, которая в памяти, то очередь не редактируется.

3. LRU (Least Recently Used): замещаем наименее используемую страницу. Для реализации этого способа нужно хранить временные метки,
которые редактируются при каждом обращении, либо список, каждый раз в конец которого кладем только что используемую. В начале списка будет менее использованная страница.
Свойство включения: (особенность) Если какая-то страница выбрана при реализации с объемом памяти M, то этаже страница при такой же траектории будет выбрана,
если память M+1 страниц (т.к. она полностью соответствует свойству локальности). Локальность - эмпирически выведенное свойство процессов, за время своей активность,
работать с небольшим ограниченным набором адресов.
Недостатки:
- Заметные накладные расходы

4. LFU (Least Frequency Used): Наименее часто используемая в последнее время. В этом способе контролируется частота обращения к странице (количество обращений).
Недостатки:
- Может быть вытеснена только что загруженная страница, не набравшая число обращений.

5. NUR (Not Used Recently): Вытеснение ранее не используемых страниц Каждому кадру физической памяти приписывается бит обращения. Работа с
битом: Вытесняется страница с битом обращения равным 0. Устанавливается в 1, когда страница загружается в какой-то кадр. Обновляется каждый раз
при обращении. Периодически все биты обращений сбрасываются в 0. Также вводится бит модификации (dirty). Он устанавливается, если в страницу была осуществлена запись.
Лучше вытеснять немодифицированную страницу, т.к. её точная копия находится на диске.

Для каждого процесса в каждый момент времени существует набор страниц которые он должен держать в памяти – рабочее множество.
Если этот набор не будет загружен возникнет трешинг страниц (постоянная загрузка и выгрузка страниц). Трешинг - процесс не может загрузить в
память все рабочее множество и все время подгружаются одни и те же страницы. Возьмем число страниц к котором обращается процесс за интервал
времени delta t(рабочее множество). Т.е. рабочее множество - это число страниц к котором обращается процесс за интервал времени delta t.

При увеличении delta t число страниц, к которым обращается процесс будет стремиться к некоторому пределу. Другими словами: процесс будет выполняться
без страничных преобразований, если ему удастся загрузить в память все нужные страницы. Если процессу не удается загрузить в память все, что ему нужно,
то возникает thrashing (подкачка одних и тех же страниц). За свое время жизни процесс меняет рабочее множество.

Глобальное замещение - может быть вытеснена любая страница любого процесса. Локальное замещение - вытесняются страницы только данного процесса.
Если у какого-то процесса слишком много страничных преобразований, то ему выделяется дополнительное количество страниц (квота). Позже можно снизить число страниц.
Т.е. можно регистрировать число выделяемых страниц.
