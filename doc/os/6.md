## 6. Разделяемые ресурсы и монопольный доступ. Обеспечение монопольного доступа к разделяемым ресурсам - взаимоисключение: алгоритм Деккерера, бесконечное откладывание и проблема активного ожидания. Взаимная блокировка процессов. Семафоры: определение, виды семафоров, примеры. Взаимоисключение при помощи семафоров.

Ресурсы могут быть разделяемые или неразделяемые. Разделяемые допускают одновременный доступ, неразделяемые допускают доступ только в порядке очереди.
Необходимость монопольного доступа к разделяемым ресурсам при взаимодействии параллельных процессов обусловлена тем, что при немонопольном доступе
возможно возникновение потерянного обновления (ситуация, когда при одновременном изменении одной переменной разными процессами теряются все изменения, кроме последнего).

Критическая секция – часть программы, исполнение которой может привести к возникновению race condition для определенного набора программ.
Чтобы исключить этот эффект по отношению к некоторому ресурсу, необходимо организовать работу так, чтобы в каждый момент времени только один
процесс мог находиться в своей критической секции, связанной с этим ресурсом.

Когда несколько процессов могут вместе асинхронно изменять области данных критических ресурсов, то им необходимо согласовывать свои действия, синхронизировать,
чтобы ресурсы находились всегда только у оодного процесса. Взаимное исключение - Отношение между процессами характеризуемое тем, что критическая секция
одного процесса не должна выполнятся, пока выполняется критическая секция другого процесса.

Тупиковая ситуация (взаимоблокировка) – когда два и более процесса удерживают и бесконечно ожидают необходимые для выполнения ресурсов. Для возникновения такой ситуации необходимо выполнение одновременно 4 условий:
1. Условия взаимного исключения;
2. Условия удержания и ожидания;
3. Условие отсутствия принудительной выгрузки ресурсов;
4. Условия циклического ожидания.

Бесконечное откладывание в планировании - ситуация, когда какой-либо процесс не получает процессорного времени.
Активное ожидание - это ситуация, в которой происходит захват и освобождение одного и того же ресурса, но полезной работы не выполняется.

Алгоритм Деккера позволяет двум потокам совместно использовать одноразовый ресурс без конфликтов, используя для связи лишь общую память.
Такое решение избавляет от dead lock, потому что процессы сбрасывают свои флаги. Так как процесс передает активность другому процессу (с помощью переменной que), исключается вечное откладывание.

Алгоритм Деккера имеет следующие ограничения:
- Алгоритм рассчитан строго на 2 процесса;
- При ожидании ресурса, процессы впустую тратят процессорное время, так как не снимаются с очереди на обслуживание;
- При попытке одновременного попадания двух процессов в критическую секцию, алгоритм позволяет войти лишь одному процессу;
- При нахождении одного из процессов в критической секции, другой процесс будет находиться в ожидании

Алгоритм Деккера основан на использовании 3-х переменных: ПР1 (процесс 1), ПР2 (процесс 2) и ОЧЕРЕДЬ.

1. Если первый процесс хочет войти в свой критический интервал, то переменная ПР2 принимает значение TRUE, т.е. значение переменной ОЧЕРЕДЬ показывает чьё именно сейчас право войти в критический интервал.
2. Если ПР1= TRUE, а ПР2=FALSE, то независимо от значения переменной ОЧЕРЕДЬ исполняется ПР1.
3. Если ПР1= TRUE и ПР2= TRUE, то дальше исполняется процесс, который определяется значением переменной ОЧЕРЕДЬ.

Завершив своё исполнение этот процесс сбрасывает флаг своего исполнения в FALSE и меняет значение переменной ОЧЕРЕДЬ на противоположное. Диапазон значений переменной ОЧЕРЕДЬ обычно колеблется в пределах [0;1] или [1;2]. Значение переменной ОЧЕРЕДЬ по сути тоже является флагом.

```java
flagp1 , flagp2: logical; 
que:int;

P1:
while (1)
begin
    flagp1 = 1;
    while(flagp2) 
    begin
        if (que == 2) then
        begin
            flagp1 = 0; 
            while(que == 2);
            flagp1 = 1;
        end 
    end
    CR1; 
    flagp1 = 0; 
    que = 2;
    PR1;
    end;        //Флаг сбрасывается. и указывается, что в критич.секцию  
                //заходит другой процесс
P2:
while (1) 
begin
    flagp2 = 1; 
    while(flagp1) 
    begin
        if (que == 1) then
        begin
           flagp2 = 0;
           while(que == 1);
           flagp2 = 1;
       end
    end
    CR2;
    flagp2 = 0;
    que = 1;
    PR2;
end;

//объявления 
flagp1, flagp2: logical;
que: int;

//начальные установки
flagp1 = 0;
flagp2 = 0;
que = 1;
parbegin;
    P1; P2;
parend;
```

Семафор — неотрицательная защищенная переменная, на которой определены 2 неделимые операции: P(S) (passeren, пропустить) и V(S) (vrygeven, освободить).
- Операция V(S) - инкремент, S = S + 1. Если S = 0, то операция V(S) может активизировать некоторый процесс блокированный на семафоре.
- Операция P(S) - декремент значения семафора, S = S - 1. Если S = 0, то декремент невозможен и процесс блокируется до тех пор, пока другой процесс не освободит ресурс.
Семафоры исключают активное ожидание на процессоре, но платой за это является переход в режим ядра. Команды, определенные на семафоре являются системными вызовами.

Процесс может создать семафор и изменять его. Удалить семафор может либо процесс создавший его, либо привелегированный процесс. При захвате и освобождении семафора происходит переключение в режим ядра, следовательно происходит переключение контекста.

Виды семафоров:
- Бинарный - принимает только 0 и 1.
- Считающий - прнимает неотрицательные целые значения.
- Множественные семафоры - массив считающих семафоров. Одной неделимой операцией можноз изменить все или часть семафоров набора.

Способы взаимодействий:
- Взаимоисключения, организация монопольного доступа процесса к разделяемой переменной (задача "Читатели-писатели")
- Синхронизация, когда процесс заинтересован в действиях другого процесса (задача "Производство-потребление")
