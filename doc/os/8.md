## 8. Тупики: недопущение тупиков. Обход тупиков - алгоритм банкира и его аппроксимации. Обнаружение и восстановление работоспособности системы.

Предотвращение тупиков возможно только за счёт нарушения условий возникновения тупиков.

- Нарушение условия взаимоисключения. Доступ к некоторым ресурсам должен быть исключительным, тем не менее некоторые устройства удаётся сделать разделяемыми.
Для предоставления такой возможности в современных системах используют механизм спулинга — данные для устройства от каждого процесса помещаются в буферные файлы,
а собственно обработку устройством этих файлов выполняет специальный системный процесс.
- Нарушение условия бесконечного ожидания. В этом случае система требует, чтобы каждый процесс запрашивал все требуемые ему ресурсы сразу, перед началом выполнения.
Если какой-либо ресурс не может быть предоставлен, процесс просто не может начать выполняться, и должен ждать освобождения всех необходимых ему ресурсов,
не удерживая при этом за собой никаких ресурсов.
- Нарушение принципа отсутствия принудительной выгрузки ресурсов. Отбирая ресурсы у удерживающих их процессов до завершения этих процессов, удалось бы добиться выполнения этого условия.
Перечислим минусы данного подхода:
  - Во-первых, отбирать у процессов можно только те ресурсы, состояние которых легко сохранить, а позднее восстановить, например состояние процессора.
  - Во-вторых, если процесс в течение некоторого времени использует определённые ресурсы, а затем освобождает эти ресурсы, он может потерять результаты
  работы, проделанной до настоящего момента.
- Нарушения условия циклического ожидания. Можно предложить упорядочить все ресурсы в системе и потребовать, чтобы каждый процесс запрашивал ресурсы
в строго определённом порядке. На практике эта схема трудно реализуема и ведёт к неэффективности использования ресурсов и существенному усложнению системы.

Обход тупика - это недопущение выполнения для процесса одного из 4-ех условий возникновения взаимоблокировки.

Среди такого рода алгоритмов наиболее известен алгоритм банкира, предложенный Дейкстрой, который базируется на безопасных или надёжных состояниях.
Безопасное состояние — это такое состояние, для которого имеется по крайней мере одна последовательность событий, которая не приведёт к тупику.
Модель алгоритма основана на действиях банкира, который, имея в наличии капитал, выдаёт кредиты.

Пусть в системе имеется n процессов и m типов ресурсов.

Вектор Available длины m содержит информацию о доступных ресурсах. Если Avaliable[j] = k, то в системе в данный момент доступно k единиц ресурса j.

Матрица Max (n x m) отображает максимальные потребности процессов в ресурсах. Если Max [i, j] = k, то процесс i может запросить максимально, k единиц ресурса j.

Матрица Allocation (n x m) отображает фактическое выделение системой ресурсов. Если Allocation [i, j] = k, то процессу i в данный момент выделено системой k единиц ресурса j.

Матрица Need (n x m) отображает оставшиеся потребности процессов в ресурсах. Если Need [i, j] = k, то процессу i могут потребоваться еще k единиц ресурса j для завершения работы.

Имеет место следующее соотношение между элементами матриц: `Need [i, j] = Max [i, j] – Allocation [i, j]`

Алгоритм запроса ресурсов для процесса P[i] (Request - вектор запросов ресурсов для процесса):

1. Если Request[i] <= Need[i], перейти к шагу 2. Иначе (процесс превысил свои максимальные потребности) – сгенерировать исключительную ситуацию.
2. Если Request[i] <= Available, перейти к шагу 3. Иначе процесс должен ждать, так как ресурс недоступен.
3. Спланировать выделение ресурса процессу P[i], модифицируя состояние системы следующим образом:
   - Available = Available - Request[i]
   - Allocation = Allocation + Request[i]
   - Need[i] = Need[i] - Request[i]
4. Вызвать алгоритм проверки безопасности полученного состояния. Если состояние безопасно, выделить ресурс процессу P[i]. Если состояние небезопасно, восстановить предыдущее состояние.

Восстановление системы.

1. Перезагрузка системы
   - Дорогое решение, так как будет потеряна вся проделанная не завершившимися процессами работа. 
   - Для системы, работающей длительное время, такой подход невозможен.
2. Последовательно завершать процессы, попавшие в тупик
   - В результате процессы, работа которых завершается, вернут занимаемые ресурсы. Этих ресурсов может оказаться достаточно, чтобы другие процессы могли успешно продолжить работу.
   - Очевидный недостаток - проделанная работа завершаемого процесса будет потеряна.
3. Завершать процессы, не имеющие отношения к тупику
   - То есть отнимать ресурсы у процессов, вернуть их системе, и мб того процессы, попавшие в тупик, смогут завершиться.
   - Решается на основе приоритетов.